---
layout: post
title: "Of Static Code Analysis, CA0001, WinMD files and C# Dynamic in Metro Style apps"
date: 2012-10-27 12:42:00 -0400
comments: true
category: Archive
tags: [".NET", "Windows 8"]
redirect_from: ["/post/2012/10/27/Of-Static-Code-Analysis-CA0001-WinMD-files-and-CSharp-Dynamic-in-Metro-Style-apps.aspx", "/post/2012/10/27/of-static-code-analysis-ca0001-winmd-files-and-csharp-dynamic-in-metro-style-apps.aspx"]
author: jay
---
<!-- more -->
<p><em>tl;dr: This article is about working around an <a href="http://msdn.microsoft.com/en-us/library/3z0aeatx.aspx">FxCop </a>internal&nbsp;bug using the C# dynamic keyword, not exactly the way is was supposed to be used.</em></p>
<p><em></em>&nbsp;</p>
<p>With the release of Windows 8 and WinRT, developing in .NET requires adding references to the new <a href="http://msdn.microsoft.com/en-us/library/windows/apps/hh755822.aspx">WinMD file format</a>.</p>
<p>This format is a .NET assembly look-alike, so look-alike that old ILDASM builds can open them.</p>
<p>These files are only containing stubs, the definition of types&nbsp;that come from WinRT, which is developed using native C++ code.</p>
<p>&nbsp;</p>
<h2>WinMD files and Static Code Analysis</h2>
<p><a href="http://msdn.microsoft.com/en-us/library/3z0aeatx.aspx">FxCop</a>&nbsp;is working rather fine with WinMD files in Metro style apps, except for one interest case, when compiling the following code :</p>
<pre class="brush: c-sharp">private static void SomeMethod()
{
   var b = new Button();
   b.Command = null;
}</pre>
<p>Which fails with the following exception when analyzed by FxCop, using the &ldquo;Microsoft Managed Recommended Rules&rdquo;:</p>
<p style="padding-left: 30px;"><span style="font-family: courier new,courier;">CA0001 : Rule=Microsoft.Reliability#CA2002, Target=App.MainPage.#SomeMethod() : The following error was encountered while reading module 'App3': Could not resolve member reference: [Windows, Version=255.255.255.255, Culture=neutral, PublicKeyToken=null] Windows.UI.Xaml.Controls.Primitives.ButtonBase::put_Command. </span></p>
<p>The reason for this is rather obscure though. It seems that FxCop is trying to analyse the declarative security attributes of WinMD exposed methods, but fails to do so&hellip; Which is ironic since these attributes cannot be used in Metro style apps :) But still, this is a multi-framework analysis engine.</p>
<p>Unfortunately, there seem to be no way to put an ignore directive, or supression attribute for this kind of internal error so fixing this, until this gets resolved by Microsoft, requires a bit of a hack.</p>
<p>&nbsp;</p>
<h2>A CA0001 workaround and the Dynamic keyword</h2>
<p>The problem here is that FxCop tries to analyze the code, and finds the put_Command() method and tries to analyse it. The goal here is to get the code compiled and executable, while having FxCop ignore it.</p>
<p>Here&rsquo;s how to do it :</p>
<pre class="brush: c-sharp">private static void SomeMethod()
{
   #if DEBUG
   var b = new Button();
   #else
   dynamic b = new Button();
   #endif

   b.Command = null;
}</pre>
<p>I <em>do</em> agree with you, really. This is not a particularly pretty code, and may not be that fast to execute, but it does the trick to still have Static Code&nbsp;Analysis running to catch all other possible code issues.</p>
<p>Having a <a href="http://msdn.microsoft.com/en-us/library/dd264736.aspx">dynamic</a> variable in Release configuration, where FxCop is executed, allows to hide the call to put_Command() as a string generated by the C# compiler, while maintaining it original meaning.</p>
<p>Here's what actually generated by the compiler, to evade FxCop scrutiny&nbsp;:</p>
<pre class="brush: c-sharp">object b = new Button();
if (MainPage.o__SiteContainer0.&lt;&gt;p__Site1 == null)
{
   MainPage.o__SiteContainer0.&lt;&gt;p__Site1 = CallSite&gt;.Create(Binder.SetMember(CSharpBinderFlags.None, "Command", typeof(MainPage), new CSharpArgumentInfo[]
   {
      CSharpArgumentInfo.Create(CSharpArgumentInfoFlags.None, null), 
      CSharpArgumentInfo.Create(CSharpArgumentInfoFlags.Constant, null)
   }));
}
MainPage.o__SiteContainer0.&lt;&gt;p__Site1.Target(MainPage.o__SiteContainer0.&lt;&gt;p__Site1, b, null);</pre>
<p>Having&nbsp;the code&nbsp;compiling using an actual static typing in Debug configuration leaves a bit of compile-time type checking, nonetheless.</p>
<p>There should be a connect entry for this soon, if you'd like to follow-up.</p>
<p>Happing dynamic hacking ! :)</p>
{% include imported_disclaimer.html %}
